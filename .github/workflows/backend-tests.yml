name: Backend Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  lint:
    name: Run Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('dev-requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install pinned tools
        run: |
          python -m pip install --upgrade pip
          pip install -r dev-requirements.txt

      - name: Run ruff format and fail if it changes files
        run: |
          # apply automatic formatting
          ruff format .
          # if ruff modified files, the working tree will have diffs; fail the job
          git --no-pager diff --exit-code || (echo "ruff format modified files; run 'ruff format .' locally and commit the changes" && exit 1)

      - name: isort check
        run: isort --check-only .

      - name: black check
        run: black --check .

  backend-tests:
    name: Run backend tests
    runs-on: ubuntu-latest
    needs: lint
    services:
      postgres:
        image: postgres:15
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: fortunes
        options: >-
          --health-cmd "pg_isready -h localhost -p 5432 -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install backend deps
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt

      - name: Wait for Postgres
        env:
          DATABASE_URL: postgresql+asyncpg://postgres:${{ secrets.POSTGRES_PASSWORD }}@localhost:5432/fortunes
        run: |
          # install a small client to check readiness
          sudo apt-get update && sudo apt-get install -y postgresql-client
          set -x
          # Increase attempts and check container health status as a fallback
          for i in {1..60}; do
            echo "Attempt $i: checking with pg_isready..."
            if pg_isready -h localhost -p 5432 -U postgres; then
              echo "pg_isready reports Postgres is ready"
              break
            fi
            echo "pg_isready not ready; trying psql connection test..."
            if PGPASSWORD=${{ secrets.POSTGRES_PASSWORD }} psql -h localhost -p 5432 -U postgres -d postgres -c '\l' >/dev/null 2>&1; then
              echo "psql connection successful"
              break
            else
              echo "psql connection failed (attempt $i)"
            fi
            # Check container health status (useful when init scripts restart the server)
            CID=$(docker ps -a --filter ancestor=postgres:15 -q | head -n1)
            if [ -n "$CID" ]; then
              HEALTH=$(docker inspect --format '{{.State.Health.Status}}' "$CID" 2>/dev/null || true)
              echo "Container $CID health=$HEALTH"
              if [ "$HEALTH" = "healthy" ]; then
                echo "Container reports healthy; trying psql once more"
                if PGPASSWORD=${{ secrets.POSTGRES_PASSWORD }} psql -h localhost -p 5432 -U postgres -d postgres -c '\l' >/dev/null 2>&1; then
                  echo "psql connection successful after container healthy"
                  break
                fi
              fi
            fi
            sleep 2
          done
          # Final verification and diagnostics if still not ready
          if ! pg_isready -h localhost -p 5432 -U postgres; then
            echo "Postgres did not become ready after 30 attempts. Printing diagnostics..."
            echo "Open TCP listeners:"
            ss -ltn || true
            echo "Attempting a final psql connection to show error output:"
            PGPASSWORD=${{ secrets.POSTGRES_PASSWORD }} psql -h localhost -p 5432 -U postgres -d postgres -c '\l' || true
            echo "Listing containers:"
            docker ps -a --format 'ID={{.ID}} Image={{.Image}} Status={{.Status}} Names={{.Names}}' || true
            echo "Logs for postgres:15 derived containers:"
            docker ps -a --filter ancestor=postgres:15 -q | xargs -r docker logs --tail 200 || true
            exit 1
          fi

      - name: Run DB migrations
        env:
          DATABASE_URL: postgresql+asyncpg://postgres:${{ secrets.POSTGRES_PASSWORD }}@localhost:5432/fortunes
          PYTHONPATH: backend
        run: |
          python backend/manage_migrate.py
          PGPASSWORD=${{ secrets.POSTGRES_PASSWORD }} psql -h localhost -U postgres -d fortunes -f backend/migrations/sample_data.sql -f backend/migrations/sample_kanji.sql
      - name: Run backend tests (with coverage and junit)
        env:
          PYTHONPATH: backend
        run: |
          pytest backend/tests -q --junitxml=backend/reports/junit.xml --cov=backend --cov-report=xml:backend/reports/coverage.xml

      - name: Upload backend coverage artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: backend/reports/coverage.xml

      - name: Upload backend junit report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-junit
          path: backend/reports/junit.xml

      - name: Annotate backend test results in PR
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
        uses: dorny/test-reporter@v2
        with:
          name: backend-tests
          path: backend/reports/junit.xml
          reporter: python-xunit
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
