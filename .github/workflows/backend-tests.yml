# yamllint disable-rule: truthy, line-length
---
name: Backend Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Run Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('backend/dev-requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install pinned tools
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/dev-requirements.txt

      - name: Run ruff format and fail if it changes files
        run: |
          # apply automatic formatting
          ruff format .
          # if ruff modified files, the working tree will have diffs; fail the job
          git --no-pager diff --exit-code || {
            echo "ruff format modified files."
            echo "Run 'ruff format .' locally and commit the changes."
            exit 1
          }

      - name: isort check
        run: isort --check-only .

      - name: black check
        run: black --check .

  backend-tests:
    name: Run backend tests
    runs-on: ubuntu-latest
    env:
      # Use NullPool in CI tests to avoid cross-event-loop connection reuse
      # which causes "Future attached to a different loop" runtime errors.
      DB_USE_NULLPOOL: true
      DB_POOL_SIZE: 5
      DB_MAX_OVERFLOW: 0
      # Ensure the backend package is importable during all steps
      PYTHONPATH: backend
      # Provide a DATABASE_URL for any step that needs it by default
      DATABASE_URL: postgresql+asyncpg://postgres:${{ secrets.POSTGRES_PASSWORD }}@localhost:5432/fortunes
    needs: lint
    services:
      postgres:
        image: postgres:15
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: fortunes
        options: >-
          --health-cmd "pg_isready -h localhost -p 5432 -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install backend deps
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt

      - name: Wait for Postgres
        env:
          DATABASE_URL: postgresql+asyncpg://postgres:${{ secrets.POSTGRES_PASSWORD }}@localhost:5432/fortunes
        run: |
          # install a small client to check readiness
          sudo apt-get update
          sudo apt-get install -y postgresql-client
          set -x
          # Increase attempts and check container health status
          PP="PGPASSWORD=${{ secrets.POSTGRES_PASSWORD }}"
          for i in {1..60}; do
            echo "Attempt $i: checking pg_isready"
            if pg_isready -h localhost -p 5432 -U postgres; then
              echo "pg_isready ok"
              break
            fi
            echo "trying psql connection test"
            if $PP psql -h localhost -U postgres -c '\l' >/dev/null 2>&1; then
              echo "psql ok"
              break
            fi
            CID=$(docker ps -a --filter ancestor=postgres:15 -q | head -n1)
            if [ -n "$CID" ]; then
              HEALTH=$(docker inspect --format '{{.State.Health.Status}}' "$CID" 2>/dev/null || true)
              echo "Container $CID health=$HEALTH"
              if [ "$HEALTH" = "healthy" ]; then
                if $PP psql -h localhost -U postgres -c '\l' >/dev/null 2>&1; then
                  echo "psql ok after healthy"
                  break
                fi
              fi
            fi
            sleep 2
          done
          # Final verification
          if ! pg_isready -h localhost -p 5432 -U postgres; then
            echo "Postgres did not become ready"
            ss -ltn || true
            $PP psql -h localhost -U postgres -c '\l' || true
            docker ps -a --filter ancestor=postgres:15 -q | \
              xargs -r docker logs --tail 200 || true
            exit 1
          fi

      - name: Run DB migrations (psql)
        env:
          PYTHONPATH: backend
          PGPASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        run: |
          set -euo pipefail
          echo "Applying SQL migrations directly with psql"
          psql -h localhost -U postgres -d fortunes -f backend/migrations/init.sql
          # load sample data
          psql -h localhost -U postgres -d fortunes -f backend/migrations/sample_data.sql
          psql -h localhost -U postgres -d fortunes -f backend/migrations/sample_kanji.sql

      - name: Run backend tests (with coverage and junit)
        env:
          PYTHONPATH: backend
        run: |
          pytest backend/tests -q \
            --junitxml=backend/reports/junit.xml \
            --cov=backend \
            --cov-report=xml:backend/reports/coverage.xml

      - name: Upload backend coverage artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: backend/reports/coverage.xml

      - name: Upload backend junit report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-junit
          path: backend/reports/junit.xml

      - name: Annotate backend test results in PR
        if: github.event_name == 'pull_request'
        uses: dorny/test-reporter@v2
        with:
          name: backend-tests
          path: backend/reports/junit.xml
          reporter: python-xunit
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
